services:
- docker

env:
  global:
  - secure: "fYxZZXHYY2UKtqy7qbiZWuNNTLuDeDRrGt0TUqLYm4UmNBBnOQfhZrMBPslhu74LC6Y5WIjBXI4rI7jKc8kSdTah82yxcNNLEuXE6VkfJFHxASSUyRZsOra4zAUqzrZ/CfpOGxomo3tgM734ioyJPo4gxoObLBqKH1lcXtbfmb1VhRWv86HirXveRCTAQaBLbzldGXK0nwgOsfCtU5fQJC5y5gmBpW33JAqKHBTemLqRtS+87txnICbuJlVMbUYUvCaOZPy+cJ6uIWJjZBehc6mswEiH6sBYCgNMj1KEl4omJdTEe2wKHWypCZnu4w3qDINZl7rr+THm0uTuo78K0mhUEa4C+ILcj3BxT1GGrBk3pv6/9wl7yV0emp5AVQ5wSW19E/pxeJace4Kw3qI7RABfuh35CvdYboxONnSKy4y3aoFkORuoeXcLp8C6RnJClsjLchFAhvmXInZ56bFx7sbwXvWVkxSkP0SIC0lbfe8rNbn7PTvXEpRSHVGRM/6dhH7PKRyOmmsvPuTQ5aCf6/b7gvym988Rj31sr54CWKJ4QYRKqeSfsEZDSWsRbT6NRjSsMVDBpMPH31uI+RSZuNndO62ueVa0r4DsjDSf735+d2cNtHPEto+GURJAIkow6l4Xdyatp7kCQ5tUl/58gqDWIXgu/oCOgsW0Z58Ek44="
  - secure: "kP5peDSNSOBxX1iIb1JsU4sJqf/1RVerEZl8/tGiJH5htYShT+qOgPI+GWoTOtx++nz7I05+VvLbloizN2uKbCc4/gH5HqsqBKLsLC5OLiSEaAq8Z3XJvcng1Gq2lWaM2xR1qk/EGwZJTx1QarRI1t97jkiFI3t9sReMUOrsHjAG77pgKFWTgp4u4kbEdgO7Eq3xzN2h+5T3mhypfX76sPXsg2tigVxPyODIQFf8VfGRwAJEN39GF8uL9spyW/V52oEBl5qrE6zZEJmLwqcZmkyzEbHTM1dI1vyEpWoW/cdDyBR7nwdiu8y8XrqvqGCSXquGTh0B3Vx/iHaq5gOsaacNm5RI47BQpLCA37BFciE4ENvxubRq45eN4sXeaqr210ODblDxG6xq8R25nLEmJC8jeV0MXbyuU10iJL5id0ZQMlDf9+9AfNQwUUwG3+Z5qQi2UL84R2fKAG2/i6CxWcUi/9VnqblCGb+AFunV/RAsVVmry/QiF1jxzZLcOHvvkLrNyW8/0pDD5nWX/Kh5gcwRe8Dq2YRdAoq9S7iPPiUgL/f8uwZdPNptJczfITDyv7o6ooat3rP6R38NueMR6MaG7pjzKzNklGzSTsH2RoxTryKeE+EOeQ/8BqkhJx6kyAMd87u2tiB65gtcXj26/s34kVpNUGV11cggbYVxA34="
  - secure: "fkIMpdB51cpOgehQo+AUthfJrxOIZWUu917F/7GpmjOxyPcVO16pROIlSiC6J1GY+o/5sD1r8bMP4LKCZ7rtBM4SUaGqEsDTwt8wPUvJy21JVxd5NCjkeJVWR3FNFzhzcg5dk/WTbZnAuOW88wWgay9NvAXFoDF/JJkkAj6Z1XrNZFcrDLfZDdDdRZUVzc02o1iJQTpnZAEG7c1Q3dEDmLRkg1ZmOZaMW+pIQuJBEGqK1tpzQSpxen5L7nzJCcb1cAMSOqTHrVEY2fCf/RS6fVedbXzJetdUbnGe0bWBpRghuIKaTozedsMlFmUiHaicNz0WAXj2nKUQTETiPWHXBaahbwjT8J1ElRBKU2QSvHQ/Gy6JqM7c0WtnqE4zXfDqplMzCtw3AcrqcUZBKO9qeT/XsNRNnHag3Q7S6OWDk4RfAmQpE6u0J9c74fRPQrr9YDLcgPqwRfsZs0aGtoIAHiqWXmeK6JV/m2U1+p6MzU/jFcq6E2UB0AP0s2FxIDf+Ch6sdSgPoqy5+jvjyFSHjxikaHjsqkFCCJuWfULzayxciOG8g72jvmU3mlwHCXUm3H6+p5JaDcONYQFQJPWeYaW8xvu1W/6sr8n/V/UcP/wXFhV0SAvtxkdrRanc3mt2fqj736Q72guSPklxYH9PFXZMeROMyejHhsGQKB+M/tc="
  - secure: "ZKPHrImvqpJLch73xUCaFq1DWmYVFJTTbPbtmDATINDxlwJrYJa90G69/bNjlAbdJyBBGbKCd/hujuIw9jyYYvM7+VJXpY+EQ7iNb3cxeIOef6C/6xMNNmYcMnaqVsGPG0rDA6bLLLbyWRWp+wy/lShO7Mvvsqa6Bzr+bDuf3Xb2aK44qMpLo2uH+xKoxftxB7uiRx4r4xdDYmCA4zdJD+09MoNPf3P1coNzPh/e62R4iuIuNHlezllkFog3z+nqBKSvIkW7cy7jjTE/PKPVNuM+ewNtWPxDDVsZLEvDHPu0BBu0bQ+v0rzQmAKUQZWdNWmqSG5cmaXwtPDVQq136F3LDZwtm6QvTroFycaWXwgDaZFGzc2bwNh6M8NOfdEVjfvkUDGC1PSDhQXY8RL2TB7hJkT1rp+U9Pu3O6GjYjEGD6Ye88DJgt2nWXlE3wjwsL9U1BMY3lPEko4PFAgiyIh0sDVFxsuAf5g1JGiRU9uizIBCaANF+W3Vy48RlnotfIYDebRsV+4Wn8tHVxFW98cBamcGPE8nu+Q9hwZVJ21mmd2V/6VByGu44+DuHmJ6E3k/RGAJG6zwZ1JUb7zq60SmO8jrn1vBAUPMG3mnIJSW2x+hkWe5zyfOSdKgPteX2uXGVHQ1T4uZXp7fmKy13cx1LvNYMejDnD+tIDq0hl8="
  - secure: "j/s43b2W0EBi53kJ3sZUt98efmvWy8ZUysNqomGEu53HwHkDEjg6JC58oIAt2WePgPgjgx3aNnz3UZrcZk7TRW2zXikbyeaCJaSh5YIBRchjoWS83t5815ppS41mbiwQ1cP/KwKoN3DqJIdl/HR8QONoAaZeW58uA4f0C9qLtSfjBt085supI5OSZuNbYefLagTxwaep8BH24oJGgUvQhJlAP0iTsWK0sVgc3Dw1xSYkzhm2XptV2HaMJDK1iJ16zzv7Jgu6t0FKIpi4O0Zc2KgJMQSELkbzHxU/joGCDVkpI5xAlUyGKuwYaMnK9t7E2QL4YWyG9ai3pEqCCx124oXJSyYbVjvE3GLLyKDek06r/dVWEgfyOZ4Ui5VfAtrpjZyMlETcLcOl3ELYM9+dLb2qTJPR73iomAwWrPPhCES1mOM+85CEUhOaDGz0qqHoqjjcjQTBOdSpcWS176/+ot5toMUWY5V7b9YmbaG84hN2jRfqerkxRNexvXtZzQESCPeiyD4fxi8iL3vzOImlrg7DmUlfpes39Z7HL9Sr8EvCW3ce4m+7csEmrsteJa+2h3dC0v7MVBX2zt+3TbQw6MuLTGWKSm+EQI8IxWW8U5/M9JfviiL+rYwE48DRDtvvygy78FumkwtCrqgaqwwUMG5NdnOskWTHjYTOVXDPII0="
  - secure: "AoKILunrSyP0yISQjLvP6jhj3rgv7vmc0Pdz76XDbc1iIiSq1EDCrfdx3E9eKNe1AhmwnfHghWzEd5tN+lY1BubYEY1y6RL5VnWp+cAq3rg8k8J3mXhmL+shgXKvs21ZUpN9D4Ih2c4H3VqpevGluHBxcA8J9aN8s39Kf6vWGdo0LV+Q3E0V9cQhKhiCRv3pjU6VSwxyszygxfvA1bL1NWal4MIsgv7ulsdnOnNYPlR9ZYb/7KjobNz2ZYaIGrCTax3jUPlD7Z9/0wWuXS3I7oDZBoLRJaVJqJnal+z3q8MacGIo23MUsjTEXgVOb9UZiV4jAcRJOvHxx5nWrH5fCdO8EUFnWFue5eLVMV7F1nRWnBN2x5/Kz+ofoiS46CCjCZe4opykugWGNDd8lt+dCLvkwTu+4zjrByaCz9iU19pGXnMD53yvuQcCamJC6bQYrV6eUDYNerC3+0tcBJE91MzkqZ3/1sR5QGar8gESvaauMQiMpQDoG628EhGhRedy/V2/K2o5FvKw5xqrCTFtAMXURGJbStjqZlRhcHqRyO9WiQK6W/NxKrdZb9/LWA4Jyny40tjnUjFM+GzN8qBAvcuVeDRhH6YTdyQNkjZLYkEiUO7qEJKdvx8uRT2toggrHS1U801E6Ia7ZzrvsZUZ/hC7FFwWN2e90xIo7NbPGLw="

script:
- docker build --target test --tag todo-app:test .
- docker run todo-app:test todo_app/tests/unit_test.py
- docker run --env-file .env.test todo-app:test todo_app/tests/test_app.py
- docker run --env MONGO_DB_CONNECTION --env MONGO_DB_NAME todo-app:test todo_app/tests_e2e/test_e2e.py


before_deploy:
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USER --password-stdin
- docker build --target production --tag $DOCKER_USER/todo-app:latest .
- docker push $DOCKER_USER/todo-app:latest
- docker login --username=_ --password=$HEROKU_API_KEY registry.heroku.com
- docker tag $DOCKER_USER/todo-app:latest registry.heroku.com/lachlanpearse-todo-app/web
- docker push registry.heroku.com/lachlanpearse-todo-app/web

deploy:
  provider: script
  script: 
  - heroku container:release web --app lachlanpearse-todo-app
  - sh ./webhook.sh
  on:
    branch: exercise-11