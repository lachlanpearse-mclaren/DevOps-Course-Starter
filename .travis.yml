services:
- docker

env:
  global:
  - secure: "fYxZZXHYY2UKtqy7qbiZWuNNTLuDeDRrGt0TUqLYm4UmNBBnOQfhZrMBPslhu74LC6Y5WIjBXI4rI7jKc8kSdTah82yxcNNLEuXE6VkfJFHxASSUyRZsOra4zAUqzrZ/CfpOGxomo3tgM734ioyJPo4gxoObLBqKH1lcXtbfmb1VhRWv86HirXveRCTAQaBLbzldGXK0nwgOsfCtU5fQJC5y5gmBpW33JAqKHBTemLqRtS+87txnICbuJlVMbUYUvCaOZPy+cJ6uIWJjZBehc6mswEiH6sBYCgNMj1KEl4omJdTEe2wKHWypCZnu4w3qDINZl7rr+THm0uTuo78K0mhUEa4C+ILcj3BxT1GGrBk3pv6/9wl7yV0emp5AVQ5wSW19E/pxeJace4Kw3qI7RABfuh35CvdYboxONnSKy4y3aoFkORuoeXcLp8C6RnJClsjLchFAhvmXInZ56bFx7sbwXvWVkxSkP0SIC0lbfe8rNbn7PTvXEpRSHVGRM/6dhH7PKRyOmmsvPuTQ5aCf6/b7gvym988Rj31sr54CWKJ4QYRKqeSfsEZDSWsRbT6NRjSsMVDBpMPH31uI+RSZuNndO62ueVa0r4DsjDSf735+d2cNtHPEto+GURJAIkow6l4Xdyatp7kCQ5tUl/58gqDWIXgu/oCOgsW0Z58Ek44="
  - secure: "kP5peDSNSOBxX1iIb1JsU4sJqf/1RVerEZl8/tGiJH5htYShT+qOgPI+GWoTOtx++nz7I05+VvLbloizN2uKbCc4/gH5HqsqBKLsLC5OLiSEaAq8Z3XJvcng1Gq2lWaM2xR1qk/EGwZJTx1QarRI1t97jkiFI3t9sReMUOrsHjAG77pgKFWTgp4u4kbEdgO7Eq3xzN2h+5T3mhypfX76sPXsg2tigVxPyODIQFf8VfGRwAJEN39GF8uL9spyW/V52oEBl5qrE6zZEJmLwqcZmkyzEbHTM1dI1vyEpWoW/cdDyBR7nwdiu8y8XrqvqGCSXquGTh0B3Vx/iHaq5gOsaacNm5RI47BQpLCA37BFciE4ENvxubRq45eN4sXeaqr210ODblDxG6xq8R25nLEmJC8jeV0MXbyuU10iJL5id0ZQMlDf9+9AfNQwUUwG3+Z5qQi2UL84R2fKAG2/i6CxWcUi/9VnqblCGb+AFunV/RAsVVmry/QiF1jxzZLcOHvvkLrNyW8/0pDD5nWX/Kh5gcwRe8Dq2YRdAoq9S7iPPiUgL/f8uwZdPNptJczfITDyv7o6ooat3rP6R38NueMR6MaG7pjzKzNklGzSTsH2RoxTryKeE+EOeQ/8BqkhJx6kyAMd87u2tiB65gtcXj26/s34kVpNUGV11cggbYVxA34="
  - secure: "fkIMpdB51cpOgehQo+AUthfJrxOIZWUu917F/7GpmjOxyPcVO16pROIlSiC6J1GY+o/5sD1r8bMP4LKCZ7rtBM4SUaGqEsDTwt8wPUvJy21JVxd5NCjkeJVWR3FNFzhzcg5dk/WTbZnAuOW88wWgay9NvAXFoDF/JJkkAj6Z1XrNZFcrDLfZDdDdRZUVzc02o1iJQTpnZAEG7c1Q3dEDmLRkg1ZmOZaMW+pIQuJBEGqK1tpzQSpxen5L7nzJCcb1cAMSOqTHrVEY2fCf/RS6fVedbXzJetdUbnGe0bWBpRghuIKaTozedsMlFmUiHaicNz0WAXj2nKUQTETiPWHXBaahbwjT8J1ElRBKU2QSvHQ/Gy6JqM7c0WtnqE4zXfDqplMzCtw3AcrqcUZBKO9qeT/XsNRNnHag3Q7S6OWDk4RfAmQpE6u0J9c74fRPQrr9YDLcgPqwRfsZs0aGtoIAHiqWXmeK6JV/m2U1+p6MzU/jFcq6E2UB0AP0s2FxIDf+Ch6sdSgPoqy5+jvjyFSHjxikaHjsqkFCCJuWfULzayxciOG8g72jvmU3mlwHCXUm3H6+p5JaDcONYQFQJPWeYaW8xvu1W/6sr8n/V/UcP/wXFhV0SAvtxkdrRanc3mt2fqj736Q72guSPklxYH9PFXZMeROMyejHhsGQKB+M/tc="
  - secure: "ZKPHrImvqpJLch73xUCaFq1DWmYVFJTTbPbtmDATINDxlwJrYJa90G69/bNjlAbdJyBBGbKCd/hujuIw9jyYYvM7+VJXpY+EQ7iNb3cxeIOef6C/6xMNNmYcMnaqVsGPG0rDA6bLLLbyWRWp+wy/lShO7Mvvsqa6Bzr+bDuf3Xb2aK44qMpLo2uH+xKoxftxB7uiRx4r4xdDYmCA4zdJD+09MoNPf3P1coNzPh/e62R4iuIuNHlezllkFog3z+nqBKSvIkW7cy7jjTE/PKPVNuM+ewNtWPxDDVsZLEvDHPu0BBu0bQ+v0rzQmAKUQZWdNWmqSG5cmaXwtPDVQq136F3LDZwtm6QvTroFycaWXwgDaZFGzc2bwNh6M8NOfdEVjfvkUDGC1PSDhQXY8RL2TB7hJkT1rp+U9Pu3O6GjYjEGD6Ye88DJgt2nWXlE3wjwsL9U1BMY3lPEko4PFAgiyIh0sDVFxsuAf5g1JGiRU9uizIBCaANF+W3Vy48RlnotfIYDebRsV+4Wn8tHVxFW98cBamcGPE8nu+Q9hwZVJ21mmd2V/6VByGu44+DuHmJ6E3k/RGAJG6zwZ1JUb7zq60SmO8jrn1vBAUPMG3mnIJSW2x+hkWe5zyfOSdKgPteX2uXGVHQ1T4uZXp7fmKy13cx1LvNYMejDnD+tIDq0hl8="
  - secure: "j/s43b2W0EBi53kJ3sZUt98efmvWy8ZUysNqomGEu53HwHkDEjg6JC58oIAt2WePgPgjgx3aNnz3UZrcZk7TRW2zXikbyeaCJaSh5YIBRchjoWS83t5815ppS41mbiwQ1cP/KwKoN3DqJIdl/HR8QONoAaZeW58uA4f0C9qLtSfjBt085supI5OSZuNbYefLagTxwaep8BH24oJGgUvQhJlAP0iTsWK0sVgc3Dw1xSYkzhm2XptV2HaMJDK1iJ16zzv7Jgu6t0FKIpi4O0Zc2KgJMQSELkbzHxU/joGCDVkpI5xAlUyGKuwYaMnK9t7E2QL4YWyG9ai3pEqCCx124oXJSyYbVjvE3GLLyKDek06r/dVWEgfyOZ4Ui5VfAtrpjZyMlETcLcOl3ELYM9+dLb2qTJPR73iomAwWrPPhCES1mOM+85CEUhOaDGz0qqHoqjjcjQTBOdSpcWS176/+ot5toMUWY5V7b9YmbaG84hN2jRfqerkxRNexvXtZzQESCPeiyD4fxi8iL3vzOImlrg7DmUlfpes39Z7HL9Sr8EvCW3ce4m+7csEmrsteJa+2h3dC0v7MVBX2zt+3TbQw6MuLTGWKSm+EQI8IxWW8U5/M9JfviiL+rYwE48DRDtvvygy78FumkwtCrqgaqwwUMG5NdnOskWTHjYTOVXDPII0="
  - secure: "BDr+gipB/jx3/Yw1ZOyYvNVYV1RC6PXk1VJPI12x0dlSmXOGbH703yrBywmeo3udT2m7SnKvnBYgPHSG5aAZlUtfTF/03GINng5GkR5V4pQLLAd0ooSZAShNlACGvcjfEuYLq1ju2GiEtRs41QTp6xqZ2kVTTwdNIfRjKt7B5hTZkSw+M+FDcTgYK8OAZFpJV2Qydiz7BA91IBI1jG/S4/IQRIIWmJcky++0k5me3pnP8CdE+EOqiIM7m7IV0RMuOFZCMSHxsKGtGSnNOPSAmRMg5gZVjWmAlnxJvxUIoCGH7bmnjYztd7qamhjoeGYyUUf76iCgo8NoY5Q4EIiWRJpzclH7035HTWOezFyO7pYLgrs0xnGM32/skCbY/3EPR4gQxXn64k6WjSvgVxSaRu6qyJ0A2us/ykxTzcYF02XCAITm/EsFBEUBQSDYl+8a1UoVWM1PV/9HYN00dhSpbAhE/4M4DMmb9UPOQqCCu6yVaj+tAp8Xnug/L9y0r0WKvXrmAZ5XyctunztG9iNNTMl+lZvOTxFjTOsju27KlxQBMg4QmZig1G2UFbEEpNLliqG57dE7j4pYKrx1UcwIiayfV2afkhTpTNloGQzlANRKngg5zWpfbyL/fRMZGS0b+UJLyHUGVM/RnBe3yf2p3Rjt5fZgw1yVWOAq/vT+Qxk="
  - secure: "I7rYEOwyppdcyRXGxjdmEXZXsQwOALyCDVCLtEcwZtBIAN1cjATJ7N81TUelpzAMJqh0i2SQVMAEIitItxd0tCYaxQAjW9qVUp66Y0lR5iA5BcTbhJcbMvKsuU9I+5VyCGHzjkcpiHIN0wD1KkAYDKZmCy57Y8efx50qet9yzv7Kp6VjTQk/Q6LRBeP9PeYMcRRtMnpEFeJYUy/I+uumeuwSgabGmltxw0gD3p/TsVmtmvhErYkD7ujfTaj6ajw9el2H/UX25eJNyghN3NRNv01zrJH2SROg0jift+nuYzGvF1Mk5ToJat2XjpLsZVWNHF1iEqtsJzzSqpQzwiDaLOF+FIxuFxL8IR6TbBQHz4TZYZUTYCljNblXrYt4LYV5xFGguk5C37x8hM3YaWMG3uo317CEwQPuETA1r7XbOPrCreV7pdyi2hx0pC04dvvOhuEUvGCcPygLCojSvibP3txPD3hgfktBdGdFlxMWCaAz1Q8f7G9vByS+io+IVVlUip/rXmGWspfDDVPzHxOA2cfHZcGUkwiA7zf1opBNIDfULNSHD5HS8ECV4yigFCGpkZ3MTCiGuc1d3MILdhvK4LvqHPMhcCYWH5PL5xMDBnNgawTxdkZNKDh9+e94rfpEXrmM6rttJfVbK8r3lA22OK2Sdx148XFJf9rYBfMUZoo="
  - secure: "jC9JqNzkOMrWwdQJE3zPeNW6ZC3Y0d2fuNHTPoIGEP2pEFJ7Da0nao/45LhCvP+nDkLcwxzxQ+cdowi1IkfxAKM9jBsOaix8w6hgF43kbeOhnh3AQw/9n2xyCAipDzwpY4NbcFDF0FXXrE6Mi4ruaQjOQXWOCpxnY5kF96IFM5tjJLajMYHHHxO13ZCkTyX99KG4kDYv3h8dVUYEngPQofByqs0cR1YZHRXU8VWCPvYp3i8pG3CeMUJMQEN0XejWEVO09f0iz4xqKBZ6IfHx7wm0ShX99iWF6l/xo3GqCFZicTMTvfnTnfEoTlho/Hl0WWJIiKANzgLKTw/gWH30ybEitjneJ5AkuG1DrcuN0rPJxIFAfaYMdxguzvezOj2CaB1Kq6wUYgpyBpF4BxoeBS4fU01/Ecy6gO5vCmIVcIp707AkE/EmgdfwpHOtO2nZRfWCASzAxR9ik9xl37iG0oo2/GsHQDzuyb4hTqHDwpKMws8RFyAIQWiuvwuizuTHEymutLCtyUN9kXuAuFTxEZH1txmjJPnT42WlxZoin4F5JfXi99uu/+0SkrmnIKkGypmc+p2Ym1Rp+MctU/4Bn6ipsKi0W4hUwnVC8yGVKCvdyp3HhJYWCjnxLQBObcq/JMVPgF7tetWGzLoEMJdFd+VezGEsh20Jm4ZtPoZT0zY="
  - secure: "c6svmk4QIvt99Mdpsmn4tjdFX6krtgKbWjtvKYHi3RzcwUSsVlDmjdSxOe3tAx02Hs6Opn1OoLRhnKxugwEIs+LMRVBiZLH65ekLadMvczBJLN8/YGIBYZyhTE1/JgrSppruIhPWrKoVZ7zo2/Oy5UKnqNyTjvNpc7WhMUWByzuH9whhjvaM6VIRHG5wYcH48atG2LgNpr0Tq4JnLzzhglAY7VfJd2AwO4a2C10sameQRQ9AQyZBTPLHC/7zQhWz/AnFlt3ztDX+ClQ9pSs1nnY1rB17+rwt0/KyM4AqB9rk85nDWlcltcr3gqiMtwjrlKZ2vTD1ZnZDa3uDjAyRAr/Iy3yUL8Cp9iQemlT0Vzd8lyUjQH+JhpA1IMjxdIEHgPnt6UwDS/TZFiPCdrV2nlD8VVpgtLgR0doO9NlcFjdYGiNziBySrDl8R8+sC2f8a4z2d2yD+YMj3mmYjyO7bfmSDUP7kZYuVZolJnPeP5/xLyvhj7CiVQKgSGRoIdc6E8MTzRPKPV8wi/WdNfq4OMfFxqCOrWjXum634EF1iiik8iUFgKiChXFGRQvyOohy4oqe9XYomdg1dIesbbEJ9AjVdnn5yKS4IroBF49k5OK15VQEyoUAeBHhAb2r1lwbMBGmUYTpMaZMOOWTsRXBi/8lkrukgXGGJV+qsAeIJZc="
  - secure: "EkeZwRR972Om8FFJi4yM115awAyDvxsKTbdStYSR4sg/KQuuP/3vBkGGrovKqkqrNz5dj34YqvbkoCqOaDuOWNNktQqg+50kxa0DlNlfqvSt4ZztKvAa/8HK7srx5hx33Yu0s8gVdt0tUKhUSD2pYUop4iJ+qv1C3FkfjJkZNzuUr+8RBMe8FdsdMbWQUNxDkYU63WJ+f9UNPiJNX21E5GN1T3Gs9rp4r6kqvYef0x4J4s6ZsIpNh5FSzc5D4GgX+aqeVyGZKkUhBVf5XamjJCtdlqZFV3SlRanpT6e/7E7n8UMh+gbIzPhaen4NFVZTOuxzsA/dbbZHO3xltYWZct79dBPXgCctiNnseH/ykPh4rGRHTRD4atnpEb2X+bHGZ+2sO823tA2PdXdh9fKVz1KCZdq02ETonJX9PMsVUtWbEqFbOpNnxb0QAvQJlHohcasMA8/yEIYOXtTM3mvdjybbPXEOr1OMofxvBJvUPCiuIuqRL4UChyDf7hO/oHAs94368KQh7JoYpIw1kZSqH042EVQ5zbdjY7LgGm2bnu5nSm+S1z3n5pxDYNJ7PKNDhhqJHA54VAOyJv4aqUHte0CFSnGC9YDPUVb9agtNFkxK9tt13tRyFRuGNp6ErtXw5tSTaMS/KlPhf/ydbokdQAGe5+xHOwBdeizQ48KTHFo="
  - TF_VERSION: "1.0.9"

script:
- docker build --target test --tag todo-app:test .
- docker run todo-app:test todo_app/tests/unit_test.py
- docker run --env-file .env.test todo-app:test todo_app/tests/test_app.py
- docker run --env MONGO_DB_CONNECTION --env MONGO_DB_NAME todo-app:test todo_app/tests_e2e/test_e2e.py

install:
- wget https://releases.hashicorp.com/terraform/$TF_VERSION/terraform_$TF_VERSION_linux_amd64.zip
- unzip terraform_$TF_VERSION_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_$TF_VERSION_linux_amd64.zip
- terraform init 

before_deploy:
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USER --password-stdin
- docker build --target production --tag $DOCKER_USER/todo-app:latest .
- docker push $DOCKER_USER/todo-app:latest
- terraform apply -auto-approve -var "prefix=lp-prod"

deploy:
  provider: script
  script: bash ./deploy.sh
  on:
    branch: exercise-12
  