services:
- docker

env:
  global:
  - secure: "fYxZZXHYY2UKtqy7qbiZWuNNTLuDeDRrGt0TUqLYm4UmNBBnOQfhZrMBPslhu74LC6Y5WIjBXI4rI7jKc8kSdTah82yxcNNLEuXE6VkfJFHxASSUyRZsOra4zAUqzrZ/CfpOGxomo3tgM734ioyJPo4gxoObLBqKH1lcXtbfmb1VhRWv86HirXveRCTAQaBLbzldGXK0nwgOsfCtU5fQJC5y5gmBpW33JAqKHBTemLqRtS+87txnICbuJlVMbUYUvCaOZPy+cJ6uIWJjZBehc6mswEiH6sBYCgNMj1KEl4omJdTEe2wKHWypCZnu4w3qDINZl7rr+THm0uTuo78K0mhUEa4C+ILcj3BxT1GGrBk3pv6/9wl7yV0emp5AVQ5wSW19E/pxeJace4Kw3qI7RABfuh35CvdYboxONnSKy4y3aoFkORuoeXcLp8C6RnJClsjLchFAhvmXInZ56bFx7sbwXvWVkxSkP0SIC0lbfe8rNbn7PTvXEpRSHVGRM/6dhH7PKRyOmmsvPuTQ5aCf6/b7gvym988Rj31sr54CWKJ4QYRKqeSfsEZDSWsRbT6NRjSsMVDBpMPH31uI+RSZuNndO62ueVa0r4DsjDSf735+d2cNtHPEto+GURJAIkow6l4Xdyatp7kCQ5tUl/58gqDWIXgu/oCOgsW0Z58Ek44="
  - secure: "kP5peDSNSOBxX1iIb1JsU4sJqf/1RVerEZl8/tGiJH5htYShT+qOgPI+GWoTOtx++nz7I05+VvLbloizN2uKbCc4/gH5HqsqBKLsLC5OLiSEaAq8Z3XJvcng1Gq2lWaM2xR1qk/EGwZJTx1QarRI1t97jkiFI3t9sReMUOrsHjAG77pgKFWTgp4u4kbEdgO7Eq3xzN2h+5T3mhypfX76sPXsg2tigVxPyODIQFf8VfGRwAJEN39GF8uL9spyW/V52oEBl5qrE6zZEJmLwqcZmkyzEbHTM1dI1vyEpWoW/cdDyBR7nwdiu8y8XrqvqGCSXquGTh0B3Vx/iHaq5gOsaacNm5RI47BQpLCA37BFciE4ENvxubRq45eN4sXeaqr210ODblDxG6xq8R25nLEmJC8jeV0MXbyuU10iJL5id0ZQMlDf9+9AfNQwUUwG3+Z5qQi2UL84R2fKAG2/i6CxWcUi/9VnqblCGb+AFunV/RAsVVmry/QiF1jxzZLcOHvvkLrNyW8/0pDD5nWX/Kh5gcwRe8Dq2YRdAoq9S7iPPiUgL/f8uwZdPNptJczfITDyv7o6ooat3rP6R38NueMR6MaG7pjzKzNklGzSTsH2RoxTryKeE+EOeQ/8BqkhJx6kyAMd87u2tiB65gtcXj26/s34kVpNUGV11cggbYVxA34="
  - secure: "fkIMpdB51cpOgehQo+AUthfJrxOIZWUu917F/7GpmjOxyPcVO16pROIlSiC6J1GY+o/5sD1r8bMP4LKCZ7rtBM4SUaGqEsDTwt8wPUvJy21JVxd5NCjkeJVWR3FNFzhzcg5dk/WTbZnAuOW88wWgay9NvAXFoDF/JJkkAj6Z1XrNZFcrDLfZDdDdRZUVzc02o1iJQTpnZAEG7c1Q3dEDmLRkg1ZmOZaMW+pIQuJBEGqK1tpzQSpxen5L7nzJCcb1cAMSOqTHrVEY2fCf/RS6fVedbXzJetdUbnGe0bWBpRghuIKaTozedsMlFmUiHaicNz0WAXj2nKUQTETiPWHXBaahbwjT8J1ElRBKU2QSvHQ/Gy6JqM7c0WtnqE4zXfDqplMzCtw3AcrqcUZBKO9qeT/XsNRNnHag3Q7S6OWDk4RfAmQpE6u0J9c74fRPQrr9YDLcgPqwRfsZs0aGtoIAHiqWXmeK6JV/m2U1+p6MzU/jFcq6E2UB0AP0s2FxIDf+Ch6sdSgPoqy5+jvjyFSHjxikaHjsqkFCCJuWfULzayxciOG8g72jvmU3mlwHCXUm3H6+p5JaDcONYQFQJPWeYaW8xvu1W/6sr8n/V/UcP/wXFhV0SAvtxkdrRanc3mt2fqj736Q72guSPklxYH9PFXZMeROMyejHhsGQKB+M/tc="
  - secure: "Q4mNsQPp0TmjTLJ/M1H5sgswAhKO9CJeXVXUHd9lN71qBCFyw6zyhdh3ULP2G6UjZdDtJAuzTeIxfWaOt4o1ZjATW20dy6KSQbUrEj0OUcbLkPagEIE5fvqzFjNj6Y3ftNeCgMaWoM4VYhgGXo7U00x6PAIxGkxJpx2u5KCp5W8kpzJ5iPPqjXA30xceD89MoVEaBWbSVIt/c5lgEVqmsj11uadI7RyC7U5vFAZJ4ivYAlZ0b0QtU7V/pemQG1ON0udQYqtaGcZmKRpSHEGKV9WMwcTTvAjyEm1sRUCFapbaf0DlfdnfVSB9S36dtqr7AJmVkT5PSMAlQr/moZ+oz8b69afqp+wkGZE5JSbSh8FmJHa29GSlhTaogxvs0TbnWUwZqE1NJay3FRzknp//4kVlNpLySiXTUxqvB9QwkUGHJgkTwAzdgPIztypLtGZ9R7pbHsDmXtGiq+vWSs2Wy5ee9JFrSXh7mdO2625ypEqBYcjEqPP47hqA6YepVRrqNOzMqRy9EmDo11gP4ZHETmrrr/l1cBucEWHAWffw4y9PHpLgmQMVkekQ4zxnjZH3i30W5vJUf7IswNHVHJzu7ORh/IJONodlkwpaBK/ftKfjNkSL6PBiUB+VPowUpM9J6/kSP0hLSUQhDLkff36dYsnIqVMy7FJe6f0YcinAWcI="
  - secure: "j/s43b2W0EBi53kJ3sZUt98efmvWy8ZUysNqomGEu53HwHkDEjg6JC58oIAt2WePgPgjgx3aNnz3UZrcZk7TRW2zXikbyeaCJaSh5YIBRchjoWS83t5815ppS41mbiwQ1cP/KwKoN3DqJIdl/HR8QONoAaZeW58uA4f0C9qLtSfjBt085supI5OSZuNbYefLagTxwaep8BH24oJGgUvQhJlAP0iTsWK0sVgc3Dw1xSYkzhm2XptV2HaMJDK1iJ16zzv7Jgu6t0FKIpi4O0Zc2KgJMQSELkbzHxU/joGCDVkpI5xAlUyGKuwYaMnK9t7E2QL4YWyG9ai3pEqCCx124oXJSyYbVjvE3GLLyKDek06r/dVWEgfyOZ4Ui5VfAtrpjZyMlETcLcOl3ELYM9+dLb2qTJPR73iomAwWrPPhCES1mOM+85CEUhOaDGz0qqHoqjjcjQTBOdSpcWS176/+ot5toMUWY5V7b9YmbaG84hN2jRfqerkxRNexvXtZzQESCPeiyD4fxi8iL3vzOImlrg7DmUlfpes39Z7HL9Sr8EvCW3ce4m+7csEmrsteJa+2h3dC0v7MVBX2zt+3TbQw6MuLTGWKSm+EQI8IxWW8U5/M9JfviiL+rYwE48DRDtvvygy78FumkwtCrqgaqwwUMG5NdnOskWTHjYTOVXDPII0="

script:
- docker build --target test --tag todo-app:test .
- docker run todo-app:test todo_app/tests/unit_test.py
#- docker run --env-file .env.test todo-app:test todo_app/tests/test_app.py
- docker run --env MONGO_DB_CONNECTION --env MONGO_DB_NAME todo-app:test todo_app/tests_e2e/test_e2e.py


before_deploy:
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USER --password-stdin
- docker build --target production --tag $DOCKER_USER/todo-app:latest .
- docker push $DOCKER_USER/todo-app:latest
- docker login --username=_ --password=$HEROKU_API_KEY registry.heroku.com
- docker tag $DOCKER_USER/todo-app:latest registry.heroku.com/lachlanpearse-todo-app/web
- docker push registry.heroku.com/lachlanpearse-todo-app/web

deploy:
  provider: script
  script: heroku container:release web --app lachlanpearse-todo-app
  on:
    branch: exercise-9